;(function(){
/** bmoor-comm v0.0.1 **/
bMoor.make("bmock.comm.Http",["bmoor.defer.Basic",function(a){function b(){return this.expecting=[],this instanceof b?void 0:new b}return{construct:b,properties:{getConnector:function(){var b,c=this,d=new a;return function(a){return c.expecting.length?(b=c.expecting.shift(),expect(a.url).toBe(b.url),expect(a.method.toUpperCase()).toBe(b.method.toUpperCase()),b.code&&200!==b.code?d.reject({message:b.response,code:b.code}):d.resolve({data:b.response,code:200})):expect(a.url).toBeUndefined(),d.promise}},expect:function(a,b){var c;return void 0===b&&(b=a,a="GET"),c={url:b,method:a,code:200,response:{}},this.expecting.push(c),{respond:function(a,b){void 0===b&&(b=a,a=200),c.response=b,c.code=a}}},hasMetExpectations:function(){expect(this.expecting.length).toBe(0)}}}}]),function(){var a,b;"undefined"==typeof window?(a=require("bmoor"),b=require("XMLHttpRequest")):(a=window.bMoor,b=window.XMLHttpRequest?function(){return new window.XMLHttpRequest(arguments)}:function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(c){}throw"error"}()),a.define("bmoor.comm.Connect",["bmoor.defer.Basic",function(c){function d(a,c,d,e,f){var g=b();return"withCredentials"in g||(g="undefined"!=typeof XDomainRequest?new XDomainRequest:null),g.open(a,c,d,e,f),g}function e(a,b,c,d,e,f){var g,h=d>=200&&300>d,i=a.protocol;this.connection=null,d="file"==i&&0===d?e?200:404:d,d=1223==d?204:d,g=h?"resolve":"reject",c[g]({status:d,headers:f,config:b,data:e})}return function(b){var f=!1,g=new c,h=d(b.method?b.method.toUpperCase():"GET",b.url,void 0===b.async?!0:b.async,b.user,b.password);return h.onload=function(){4==h.readyState&&e(a.url.resolve(b.url),b,g,f?-2:h.status,h.responseType?h.response:h.responseText,h.getAllResponseHeaders())},a.forEach(b.headers,function(a,b){h.setRequestHeader(b,a)}),b.mimeType&&h.overrideMimeType(b.mimeType),b.responseType&&(h.responseType=b.responseType),h.send(b.data||null),g.promise.abort=function(){f=!0,h.abort()},g.promise}}])}(),bMoor.define("bmoor.comm.Stream",["-bmoor.comm.Http","bmoor.defer.Basic","bmoor.flow.Interval","bmoor.flow.Timeout",function(a,b,c,d){"use strict";function e(a){function b(b){return a[b]||e.settings[b]}var h;return bMoor.isString(a)&&(a={url:a}),h=function(){function i(){t?d.set(function(){g[r]=null},t):g[r]=null}function j(a){var b=a.then(function(a){var b=u?u(a):a,c=b.data,d=b.code;return y&&y.call(o),v&&!v(d,c)?(Array.prototype.unshift.call(n,b),x.apply(o,n)):w?(Array.prototype.unshift.call(n,c),w.apply(o,n)):c},function(a){return y&&y.call(o),Array.prototype.unshift.call(n,a),x.apply(o,n)});return b}function k(){var b;return a.preload&&(b="function"==typeof a.preload?a.preload():a.preload),bMoor.isObject(b)&&b.then||(b=bMoor.dwrap(b)),b}function l(){var b;return a.massage&&Array.prototype.push.call(n,a.massage.apply(o,n)),a.response?(b="function"==typeof a.response?a.response.apply(o,n):a.response,b.then?b.then(function(a){return{data:a,code:200}}):bMoor.dwrap({data:b,code:200})):s(bMoor.object.extend({method:p,data:n[n.length-1],url:q,headers:bMoor.object.extend({"Content-Type":"application/json"},e.settings.headers,a.headers)},a.comm||e.settings.comm))}var m,n=arguments,o=a.context||this,p=a.method||"GET",q=bMoor.isFunction(a.url)?a.url.apply(o,n):a.url,r=p+"::"+q,s=b("http"),t=b("linger"),u=b("decode"),v=b("validation"),w=b("success"),x=b("failure"),y=b("always");return k().then(function(){var b,d,e;return a.cached&&f[r]?f[r]:g[r]?g[r]:(d=function(){return j(l())},void 0===a.interval||g[r]?b=d():(e=function(){return h.lastRun=(new Date).getTime(),d()},h.setInterval=function(d){var i=(new Date).getTime();b=!h.lastRun||i-d<h.lastRun||h.lastInterval&&h.lastInterval>d?e():q&&a.cached?f[r]:h.lastResponse,h.lastInterval=d,m&&c.clear(m),m=c.set(function(){g[r]=e()},d)},h.stopRefresh=function(){c.clear(m),a.onStopRefresh&&a.onStopRefresh.call(o)},a.interval?h.setInterval(a.interval):b=e()),q&&(g[r]=b,a.cached&&(f[r]=b),b.then(i,i)),h.lastResponse=b,b)},function(){return Array.prototype.unshift.call(n,{code:0,message:"Preload Error"}),a.failure.apply(o,n)})}}var f={},g={};return e.settings={interval:!1,linger:30,http:a,comm:{},headers:{}},e}]),bMoor.make("bmoor.comm.Streamer",["bmoor.extender.Mixin","bmoor.comm.Stream",function(a,b){"use strict";return{parent:a,construct:function(a){var c=this;bMoor.iterate(a,function(a,d){c[d]=new b(a)})}}}]),function(){"use strict";var a,b,c,d;"undefined"!=typeof window&&(a=window.XMLHttpRequest,window.XMLHttpRequest=function(){return d()},bMoor.make("bmoor.http.Intercept",["bmoor.defer.Basic","bmoor.http.Router",function(e,f){var g,h;return c={enable:function(){d=b},expect:function(a){g||(g=[]),g.push(a)},routes:function(a){h=new f(a)},router:function(a){h=a}},{wrap:a,construct:function(a){this.$wrap(a)},statics:c,properties:{open:function(a,b,c,d,e){this.intercept=null,g&&g.length?this.intercept=g.shift():h&&(this.intercept=h.match(b)),this.$wrapped.open(a,b,c,d,e)},send:function(a){var b=this,c=this.intercept;bMoor.isFunction(c)&&(c=c(a)),c?(this.status=c.status||200,this.response=c.response,this.readyState=4,this.responseType=c.responseType||"json",this.getAllResponseHeaders=function(){return{some:"header"}},this.onload&&this.onload()):(this.$wrapped.onload=function(){b.status=this.status,b.response=this.response,b.readyState=this.readyState,b.responseType=this.responseType,b.responseText=this.responseText,b.onload.apply(b,arguments)},this.$wrapped.send(a))}},finalize:function(c){d=function(b){return new a(b)},b=function(a){return new c(a)}}}}]))}(),bMoor.make("bmoor.http.Router",[function(){function a(a,c,d,e){bMoor.isObject(c)?bMoor.each(c,function(c,e){b(a,e,d,c)}):b(a,c,d,e)}function b(a,b,c,d){var e,f=c&&c.method?c.method.toUpperCase():"GET",g=a.routes[f],h=b.split("/");for(g||(g=a.routes[f]={});h.length;)e=h.shift(),g[e]||(g[e]={}),g=g[e];g.$func=d}return{construct:function(a,b,c){this.setRoutes(a,b,c)},properties:{setRoutes:function(b,c,d){this.routes={},2===arguments.length&&bMoor.isFunction(c)&&(d=c,c=null),a(this,b,c,d)},addRoute:function(a,c,d){2===arguments.length&&bMoor.isFunction(c)&&(d=c,c=null),b(this,a,c,d)},match:function(a,b){var c,d,e,f,g;for(1==arguments.length&&(b=a,a="GET"),f=this.routes[a.toUpperCase()],g=b.split("/");g.length&&f;)c=g.shift(),f=f[c],f&&f.$func&&(d=f.$func,e=g.slice(0));return d?d.apply(d,e):void 0}}}}]),bMoor.make("bmoor.storage.Local",[function(){"use strict";return{construct:function(a){this.name=a},properties:{create:function(a,b){var c,d;return b[a]?c=b[a]:(c=1e8*Math.random(),b[a]=c),d=localStorage[this.name]?JSON.parse(localStorage[this.name]):[],d.push(c),localStorage[this.name]=JSON.stringify(d),localStorage[this.name+"-"+c]=JSON.stringify(b),bMoor.dwrap(b)},update:function(a,b){return localStorage[this.name+"-"+a]=JSON.stringify(b),bMoor.dwrap(b)},partial:function(a,b){var c;return localStorage[this.name+"-"+a]&&(c=JSON.parse(localStorage[this.name+"-"+a]),localStorage[this.name+"-"+a]=JSON.stringify(bMoor.merge(c,b))),bMoor.dwrap(c)},get:function(a){var b,c,d;if(bMoor.isArrayLike(a)){for(d=[],b=0,c=a.length;c>b;b++)d[b]=JSON.parse(localStorage[this.name+"-"+a[b]]);return bMoor.dwrap(d)}return bMoor.dwrap(JSON.parse(localStorage[this.name+"-"+a]))},getAll:function(){var a,b,c,d;if(localStorage[this.name]){for(d=[],c=JSON.parse(localStorage[this.name]),a=0,b=c.length;b>a;a++)d.push(JSON.parse(localStorage[this.name+"-"+c[a]]));return bMoor.dwrap(d)}return bMoor.drwap([])},remove:function(a){var b,c,d,e;if(localStorage[this.name]){if(e=JSON.parse(localStorage[this.name]),bMoor.isArrayLike(a))for(d=[],b=0,c=a.length;c>b;b++)localStorage.removeItem(this.name+"-"+a[b]),d.push(bMoor.array.remove(e,a[b]));else localStorage.removeItem(this.name+"-"+a),d=bMoor.array.remove(e,a);return localStorage[this.name]=JSON.stringify(e),bMoor.dwrap(d)}},destroy:function(){var a,b,c;if(localStorage[this.name]){for(c=JSON.parse(localStorage[this.name]),a=0,b=c.length;b>a;a++)localStorage.removeItem(this.name+"-"+c[a]);localStorage.removeItem(this.name)}return bMoor.dwrap(!0)}}}}]),bMoor.make("bmoor.storage.Mongo",["bmoor.extender.Mixin",function(a){"use strict";return{parent:a,construct:function(){},properties:{create:function(){},update:function(){},partial:function(){},get:function(){},getAll:function(){},remove:function(){}}}}]),bMoor.make("bmoor.storage.Remote",["bmoor.comm.Streamer",function(a){"use strict";return{construct:function(a,b){this.root=b,this.name=a},extend:[new a({create:{url:function(){return this.root},method:"POST",success:function(a,b){return bMoor.isFunction(b)||a[b]||(a[b]=1e8*Math.random()),a}},update:{url:function(a){return this.root+"/"+a},method:"POST"},partial:{url:function(a){return this.root+"/"+a},method:"POST"},get:{url:function(a){return bMoor.isArray(a)?this.root+"/"+a.join(","):this.root+"/"+a},method:"GET"},getAll:{url:function(){return this.root},method:"GET"},remove:{url:function(a){return this.root+"/"+a},method:"DELETE"},destroy:{url:function(){alert("TODO : destroy")}}})]}}]),function(){"use strict";"undefined"!=typeof angular&&bMoor.define("bmoor.comm.adapter.Angular",["bmoor.defer.Basic",function(a){var b=angular.injector(["ng"]).get("$http");return function(c){var d=new a;return b(c).then(function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise}}])}();
//# sourceMappingURL=bmoor-comm.min.js.map
}());